<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>如何合理地停止一个正在运行的java线程 | Jayzalex&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="不能使用Thread.stop()方法的原因

Thread.stop()主要通过抛出一个ThreadDeath异常来中断线程运行。但是这个方法是不安全的，这是因为当调用Thread.stop()方法时，会发生下面两件事：


即刻抛出ThreadDeath异常，在线程的run()方法内，任何一点都有可能抛出ThreadDeath Error，包括在catch或finally语句中。
释放该线程所">
<meta property="og:type" content="article">
<meta property="og:title" content="如何合理地停止一个正在运行的java线程">
<meta property="og:url" content="http://jayzalex.github.io/2015/01/15/properly-stop-thread/">
<meta property="og:site_name" content="Jayzalex's Blog">
<meta property="og:description" content="不能使用Thread.stop()方法的原因

Thread.stop()主要通过抛出一个ThreadDeath异常来中断线程运行。但是这个方法是不安全的，这是因为当调用Thread.stop()方法时，会发生下面两件事：


即刻抛出ThreadDeath异常，在线程的run()方法内，任何一点都有可能抛出ThreadDeath Error，包括在catch或finally语句中。
释放该线程所">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何合理地停止一个正在运行的java线程">
<meta name="twitter:description" content="不能使用Thread.stop()方法的原因

Thread.stop()主要通过抛出一个ThreadDeath异常来中断线程运行。但是这个方法是不安全的，这是因为当调用Thread.stop()方法时，会发生下面两件事：


即刻抛出ThreadDeath异常，在线程的run()方法内，任何一点都有可能抛出ThreadDeath Error，包括在catch或finally语句中。
释放该线程所">

  
    <link rel="alternative" href="/atom.xml" title="Jayzalex&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<div class="profilepic">
			<img src="http://pic2.zhimg.com/7cf89a0bb_l.jpg">
		</div>

		<hgroup>
		  <h1 class="header-author"><a href="/">Jayzalex</a></h1>
		</hgroup>

		
		<p class="header-subtitle">编程是最易习得的超能力～</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/jayzAlex" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://www.weibo.com/1300109375" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud">
						<a href="/tags/JavascriptInterface/" style="font-size: NaNpx;">JavascriptInterface</a><a href="/tags/WebView/" style="font-size: NaNpx;">WebView</a><a href="/tags/android/" style="font-size: NaNpx;">android</a><a href="/tags/googleapis/" style="font-size: NaNpx;">googleapis</a><a href="/tags/hexo/" style="font-size: NaNpx;">hexo</a><a href="/tags/java/" style="font-size: NaNpx;">java</a><a href="/tags/thread/" style="font-size: NaNpx;">thread</a><a href="/tags/useso/" style="font-size: NaNpx;">useso</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					一个Android开发者 + 手机控 + 技术脑残粉 + Google脑残粉，爱技术，爱尝鲜，也爱赚钱！
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay"></div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="http://pic2.zhimg.com/7cf89a0bb_l.jpg">
			</div>

			<hgroup>
			  <h1 class="header-author"><a href="/">Jayzalex</a></h1>
			</hgroup>
			
			<p class="header-subtitle">编程是最易习得的超能力～</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/jayzAlex" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://www.weibo.com/1300109375" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <article id="post-properly-stop-thread" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/15/properly-stop-thread/" class="article-date">
  	<time datetime="2015-01-15T07:12:21.000Z" itemprop="datePublished">Jan 15 2015</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/thread/">thread</a></li></ul>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      如何合理地停止一个正在运行的java线程
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="不能使用Thread-stop()方法的原因">不能使用Thread.stop()方法的原因</h1>
<hr>
<p>Thread.stop()主要通过抛出一个ThreadDeath异常来中断线程运行。但是这个方法是不安全的，这是因为当调用Thread.stop()方法时，会发生下面两件事：</p>
<blockquote>
<ol>
<li>即刻抛出ThreadDeath异常，在线程的run()方法内，任何一点都有可能抛出ThreadDeath Error，包括在catch或finally语句中。</li>
<li>释放该线程所持有的所有的锁</li>
</ol>
</blockquote>
<p>方法的doc解释为：</p>
<blockquote>
<p>This method is inherently unsafe. Stopping a thread with Thread.stop causes it to unlock all of the monitors that it has locked (as a natural consequence of the unchecked ThreadDeath exception propagating up the stack). If any of the objects previously protected by these monitors were in an inconsistent state, the damaged objects become visible to other threads, potentially resulting in arbitrary behavior.……</p>
</blockquote>
<p>中文意思是：</p>
<blockquote>
<p>该方法天生是不安全的。使用thread.stop()停止一个线程，导致释放（解锁）所有该线程已经锁定的监视器（因沿堆栈向上传播的未检查异常ThreadDeath而解锁）。如果之前受这些监视器保护的任何对象处于不一致状态，则不一致状态的对象（受损对象）将对其他线程可见，这可能导致任意的行为。</p>
</blockquote>
<p>所以说，<strong>通过Thread.stop()停止一个正在运行的java线程是行不通的</strong>。<br>更多请参考：<br><a href="http://yeziwang.iteye.com/blog/844649" target="_blank" rel="external">为什么不能使用Thread.stop()方法？</a></p>
<h1 id="停止flag+Thread-interrupt()停止线程运行">停止flag+Thread.interrupt()停止线程运行</h1>
<hr>
<p>Thread.interrupt()的方法的主要作用是：<br>中断本线程。无返回值。具体作用分以下几种情况：</p>
<blockquote>
<ol>
<li>如果该线程正阻塞于Object类的wait()、wait(long)、wait(long, int)方法，或者Thread类的join()、join(long)、join(long, int)、sleep(long)、sleep(long, int)方法，则该线程的中断状态将被清除，并收到一个java.lang.InterruptedException。</li>
<li>如果该线程正阻塞于interruptible channel上的I/O操作，则该通道将被关闭，同时该线程的中断状态被设置，并收到一个java.nio.channels.ClosedByInterruptException。</li>
<li>如果该线程正阻塞于一个java.nio.channels.Selector操作，则该线程的中断状态被设置，它将立即从选择操作返回，并可能带有一个非零值，就好像调用java.nio.channels.Selector.wakeup()方法一样。</li>
<li>如果上述条件都不成立，则该线程的中断状态将被设置。</li>
</ol>
</blockquote>
<p>是不是感觉有点晕XD。实际上简单点地说，就是<strong>当线程阻塞于wait/join/sleep是，中断状态会被清除掉，同时收到InterruptedException；而其他情况中断状态都被设置，并不一定收到异常</strong>。也就是说，interrupt只能通过抛出异常的形式，中断处于wait/join/sleep阻塞状态的线程。最后，我是通过在循环条件里面加一个检测停止条件volatile的flag(也就是running)，同时调用Thread.interrupt()方法。具体代码如下：</p>
<figure class="highlight java"><pre><div class="line"><span class="keyword">import</span> java.util.logging.Logger;</div><div class="line"></div><div class="line"><span class="javadoc">/**</span></div><div class="line"> * Created by jayzalex on 2015/1/15.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkingThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>{</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> running = <span class="keyword">true</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = Logger.getLogger(<span class="string">"Log"</span>);</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(String[] args) <span class="keyword">throws</span> InterruptedException {</div><div class="line">		WorkingThread t = <span class="keyword">new</span> WorkingThread();</div><div class="line">		t.start();</div><div class="line">		Thread.sleep(<span class="number">1000</span>);</div><div class="line">		t.terminate();</div><div class="line">		t.join(); <span class="comment">// 调用join方法，检测线程是不是die</span></div><div class="line">		LOGGER.info(<span class="string">"Thread successfully stopped."</span>);</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">terminate</span>() {</div><div class="line">		running = <span class="keyword">false</span>; <span class="comment">// 发出停止信号</span></div><div class="line">		interrupt(); <span class="comment">// 考虑到阻塞于wait()或sleep()的情况，同时调用interrupt()</span></div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="annotation">@Override</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">		<span class="keyword">while</span> (running) { <span class="comment">// 检测条件变量</span></div><div class="line">			<span class="keyword">try</span> {</div><div class="line">				LOGGER.info(<span class="string">"Sleep..."</span>);</div><div class="line">				Thread.sleep(<span class="number">100</span>);</div><div class="line">				LOGGER.info(<span class="string">"Processing..."</span>);</div><div class="line">				<span class="comment">// do dirty work // 业务代码</span></div><div class="line">			} <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line">				e.printStackTrace();</div><div class="line">				running = <span class="keyword">false</span>;</div><div class="line">			}</div><div class="line">		}</div><div class="line">		LOGGER.info(<span class="string">"Stopped."</span>);</div><div class="line">	}</div><div class="line"></div><div class="line">}</div></pre></figure>

<h1 id="参考资料">参考资料</h1>
<hr>
<ol>
<li><a href="http://stackoverflow.com/questions/10961714/how-to-properly-stop-the-thread-in-java" target="_blank" rel="external">How to properly stop the Thread in Java</a></li>
<li><a href="http://ibruce.info/2013/12/19/how-to-stop-a-java-thread/" target="_blank" rel="external">如何停止一个正在运行的java线程</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2014/12/11/android-jsinterface/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">android-jsinterface</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="properly-stop-thread" data-title="如何合理地停止一个正在运行的java线程" data-url="http://jayzalex.github.io/2015/01/15/properly-stop-thread/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 Jayzalex
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>

  <script src="/js/main.js" type="text/javascript"></script>


  </div>
</body>
</html>